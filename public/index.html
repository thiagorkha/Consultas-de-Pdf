<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App PWA de Consulta</title>
    <!-- Configuração PWA básica -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padrão */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos de transição para as telas */
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Container Principal do Aplicativo -->
    <div id="app-container" class="bg-white shadow-xl rounded-xl w-full max-w-lg p-6 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Consulta PDF</h1>
            <p id="app-subtitle" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Área de Telas -->
        <div id="screen-area">

            <!-- Tela Inicial (Menu) -->
            <div id="home-screen" class="screen flex flex-col space-y-4">
                <button onclick="navigateTo('consulta-screen')" 
                        class="w-full bg-blue-700 hover:bg-blue-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    1. Consultar Termos (CPxx_xxxx_xx)
                </button>
                <button onclick="navigateTo('visualizar-screen')" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    2. Visualizar Arquivo PDF
                </button>
                <button onclick="navigateTo('construcao-screen')" 
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    3. Outras Opções (Em Construção)
                </button>
            </div>

            <!-- Tela 1: Consulta e Extração de Termos -->
            <div id="consulta-screen" class="screen hidden">
                <button onclick="navigateTo('home-screen')" class="mb-4 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar
                </button>
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Extração de Termos</h2>
                <input type="text" id="pdf-consulta-input" placeholder="Nome do arquivo PDF (ex: relatorio_a)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
                
                <button onclick="consultarPdf()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Consultar e Extrair Termos
                </button>

                <!-- Resultado da Consulta -->
                <div id="consulta-result-area" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg hidden">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">Termos Encontrados (Estrutura: CPxx_xxxx_xx):</h3>
                    <pre id="extracted-terms" class="text-sm overflow-x-auto whitespace-pre-wrap break-words p-3 bg-white border border-gray-300 rounded-md text-gray-800"></pre>
                    
                    <button onclick="salvarTermosTxt()" id="save-txt-button"
                            class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        Salvar Lista em .txt
                    </button>
                </div>
                <p id="consulta-error" class="text-red-500 mt-4 hidden"></p>
            </div>

            <!-- Tela 2: Visualização do PDF -->
            <div id="visualizar-screen" class="screen hidden">
                <button onclick="navigateTo('home-screen')" class="mb-4 text-green-600 hover:text-green-800 font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar
                </button>
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Visualizar PDF</h2>
                <input type="text" id="pdf-visualizar-input" placeholder="Nome do arquivo PDF (ex: relatorio_a)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-4">
                
                <button onclick="visualizarPdf()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Visualizar
                </button>
                <p id="visualizar-error" class="text-red-500 mt-4 hidden"></p>
            </div>

            <!-- Tela 3: Em Construção -->
            <div id="construcao-screen" class="screen hidden">
                <button onclick="navigateTo('home-screen')" class="mb-4 text-yellow-600 hover:text-yellow-800 font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar
                </button>
                <div class="text-center p-10 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <svg class="w-12 h-12 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2v-2m0 2v2m0 2V8m0 2v2m0 2v2m0 2v2m0 2v-2m0-12a9 9 0 100 18 9 9 0 000-18zm0 0h.01"></path></svg>
                    <h2 class="text-2xl font-bold text-yellow-700">Em Construção</h2>
                    <p class="text-yellow-600 mt-2">Esta funcionalidade está sendo desenvolvida e estará disponível em breve. Agradecemos a sua paciência!</p>
                </div>
            </div>

        </div>

    </div>

    <!-- Script JavaScript -->
    <script>
        // Configuração
        const PDF_BASE_PATH = './assets/pdfs/';
        
        // Simulação de conteúdo de PDF para fins de demonstração (Mock de Extração)
        // Em um ambiente real, você faria uma chamada a uma API para ler o conteúdo do PDF.
        const MOCK_PDF_CONTENTS = {
            "relatorio_a": "Este é um texto de teste. O termo principal é CP12_3456_78. Temos outro termo importante, CP01_9876_54, e mais um: CP99_1111_22.",
            "exemplo_completo": "A norma CP45_0001_01 está sendo revisada. O novo código será CP45_0002_01. A CP00_0000_00 é a base. E o termo final é CP10_2000_30.",
        };

        let lastExtractedTerms = []; // Variável para armazenar os termos extraídos para o download

        /**
         * Lida com a navegação entre as telas.
         * @param {string} screenId - O ID da tela para a qual navegar.
         */
        function navigateTo(screenId) {
            const screens = document.querySelectorAll('.screen');
            const subtitle = document.getElementById('app-subtitle');

            screens.forEach(screen => {
                screen.classList.add('hidden');
            });

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                
                // Atualiza o subtítulo
                switch(screenId) {
                    case 'home-screen':
                        subtitle.textContent = 'Selecione uma opção abaixo.';
                        break;
                    case 'consulta-screen':
                        subtitle.textContent = 'Insira o nome do arquivo para extração.';
                        break;
                    case 'visualizar-screen':
                        subtitle.textContent = 'Insira o nome do arquivo para visualização.';
                        break;
                    case 'construcao-screen':
                        subtitle.textContent = 'Funcionalidade futura.';
                        break;
                }
            }
        }

        /**
         * Simula a consulta ao PDF, extraindo termos CPxx_xxxx_xx.
         */
        function consultarPdf() {
            const fileNameInput = document.getElementById('pdf-consulta-input');
            const resultArea = document.getElementById('consulta-result-area');
            const termsDisplay = document.getElementById('extracted-terms');
            const errorDisplay = document.getElementById('consulta-error');
            
            const fileName = fileNameInput.value.trim().toLowerCase();
            const fullFileName = fileName.endsWith('.pdf') ? fileName.slice(0, -4) : fileName;

            resultArea.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            termsDisplay.textContent = 'Aguardando consulta...';

            if (!fileName) {
                errorDisplay.textContent = 'Por favor, preencha o nome do arquivo PDF.';
                errorDisplay.classList.remove('hidden');
                return;
            }

            // 1. Simulação de Leitura do Conteúdo do PDF (MOCK)
            const pdfContent = MOCK_PDF_CONTENTS[fullFileName];

            if (!pdfContent) {
                errorDisplay.textContent = `Erro: Arquivo "${fileName}.pdf" não encontrado no MOCK. Tente "relatorio_a" ou "exemplo_completo" (ou verifique o caminho real).`;
                errorDisplay.classList.remove('hidden');
                lastExtractedTerms = [];
                return;
            }

            // 2. Extração usando Expressão Regular
            // Padrão: CP seguido por 2 dígitos, underscore, 4 dígitos, underscore, 2 dígitos
            const regex = /CP\d{2}_\d{4}_\d{2}/g;
            const matches = pdfContent.match(regex) || [];

            // 3. Formatação do resultado conforme solicitado: "CPxx_xxxx_xx", "CPxx_xxxx_xx", ...
            lastExtractedTerms = matches.map(term => `"${term}"`);
            
            if (lastExtractedTerms.length > 0) {
                const formattedOutput = lastExtractedTerms.join(',\n');
                termsDisplay.textContent = formattedOutput;
                resultArea.classList.remove('hidden');
                errorDisplay.classList.add('hidden');
            } else {
                termsDisplay.textContent = 'Nenhum termo no padrão CPxx_xxxx_xx foi encontrado neste arquivo.';
                resultArea.classList.remove('hidden');
                // Remove o botão de salvar se não houver termos
                document.getElementById('save-txt-button').classList.add('hidden');
            }
        }

        /**
         * Salva a lista de termos extraídos em um arquivo .txt.
         */
        function salvarTermosTxt() {
            if (lastExtractedTerms.length === 0) {
                alertUser('info', 'Não há termos para salvar. Realize uma consulta primeiro.');
                return;
            }

            const fileNameInput = document.getElementById('pdf-consulta-input').value.trim();
            const fileName = fileNameInput || 'termos_extraidos';

            const content = lastExtractedTerms.join(',\n');
            const blob = new Blob([content], { type: 'text/plain' });
            
            // Cria um link de download temporário
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${fileName}_extraidos.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);

            alertUser('success', `Arquivo "${a.download}" salvo com sucesso!`);
        }

        /**
         * Abre o arquivo PDF em uma nova aba para visualização.
         */
        function visualizarPdf() {
            const fileNameInput = document.getElementById('pdf-visualizar-input');
            const errorDisplay = document.getElementById('visualizar-error');
            const fileName = fileNameInput.value.trim().toLowerCase();
            
            errorDisplay.classList.add('hidden');

            if (!fileName) {
                errorDisplay.textContent = 'Por favor, preencha o nome do arquivo PDF.';
                errorDisplay.classList.remove('hidden');
                return;
            }

            const pdfName = fileName.endsWith('.pdf') ? fileName : `${fileName}.pdf`;
            const pdfUrl = `${PDF_BASE_PATH}${pdfName}`;

            // Abre o PDF em uma nova aba (melhor UX para visualização de PDFs)
            window.open(pdfUrl, '_blank');
            alertUser('success', `Tentando abrir o arquivo: ${pdfName}`);
        }

        /**
         * Função de utilidade para exibir mensagens ao usuário (substituindo o alert nativo).
         * Aqui é uma simulação simples de alerta.
         */
        function alertUser(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Implementação simples de feedback no rodapé
            const appContainer = document.getElementById('app-container');
            let feedback = document.getElementById('app-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'app-feedback';
                feedback.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-medium transition-opacity duration-300 opacity-0';
                appContainer.appendChild(feedback);
            }

            const baseClass = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-medium transition-opacity duration-300';
            
            if (type === 'success') {
                feedback.className = `${baseClass} bg-green-500 opacity-100`;
            } else if (type === 'error') {
                feedback.className = `${baseClass} bg-red-500 opacity-100`;
            } else {
                 feedback.className = `${baseClass} bg-gray-500 opacity-100`;
            }

            feedback.textContent = message;

            // Esconde após 3 segundos
            clearTimeout(feedback.timer);
            feedback.timer = setTimeout(() => {
                feedback.classList.remove('opacity-100');
                feedback.classList.add('opacity-0');
            }, 3000);
        }

        // PWA - Registro do Service Worker (SW)
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // O arquivo 'service-worker.js' precisa ser criado separadamente,
                    // mas registramos ele aqui.
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('SW registrado com sucesso. Escopo:', registration.scope);
                        })
                        .catch(error => {
                            console.error('Falha no registro do SW:', error);
                        });
                });
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('home-screen');
            // Nota: Para PWA completo, você precisará criar o service-worker.js e manifest.json.
            // registerServiceWorker(); 
        });

    </script>
</body>
</html>

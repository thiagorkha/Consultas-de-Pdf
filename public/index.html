<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App PWA de Consulta</title>
    <!-- Configuração PWA básica -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padrão */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos de transição para as telas */
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Biblioteca PDF.js (Necessário para ler PDFs no lado do cliente/navegador) -->
    <!-- Define o worker para a extração -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script>
        // Configura o worker para o PDF.js
        window.pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Container Principal do Aplicativo -->
    <div id="app-container" class="bg-white shadow-xl rounded-xl w-full max-w-lg p-6 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Consulta PDF</h1>
            <p id="app-subtitle" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Área de Telas -->
        <div id="screen-area">

            <!-- Tela Inicial (Menu) -->
            <div id="home-screen" class="screen flex flex-col space-y-4">
                <button onclick="navigateTo('consulta-screen')" 
                        class="w-full bg-blue-700 hover:bg-blue-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Iniciar Extração de Termos
                </button>
                <!-- As opções 2 e 3 foram removidas conforme solicitado -->
            </div>

            <!-- Tela 1: Consulta e Extração de Termos -->
            <div id="consulta-screen" class="screen hidden">
                <button onclick="navigateTo('home-screen')" class="mb-4 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar ao Menu
                </button>
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Extração de Termos (Client-Side)</h2>
                
                <!-- Seleção da Estrutura de Consulta -->
                <label for="extraction-type" class="block text-sm font-medium text-gray-700 mb-2">
                    Selecione a Estrutura de Termo a Consultar:
                </label>
                <select id="extraction-type" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 bg-white appearance-none">
                    <option value="CP">CPxx_xxxx_xx</option>
                    <option value="MT">MTxx_xxxx_xx</option>
                </select>

                <!-- Input de Arquivo -->
                <label for="pdf-consulta-file" class="block text-sm font-medium text-gray-700 mb-2">
                    Selecione o arquivo PDF para extração:
                </label>
                <input type="file" id="pdf-consulta-file" accept=".pdf" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 bg-white">
                
                <button onclick="consultarPdf()" id="consultar-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center">
                    Consultar e Extrair Termos
                    <div id="loading-spinner" class="loading-spinner w-5 h-5 border-4 border-t-transparent border-white rounded-full ml-3 hidden"></div>
                </button>

                <!-- Resultado da Consulta -->
                <div id="consulta-result-area" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg hidden">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">Termos Encontrados:</h3>
                    <pre id="extracted-terms" class="text-sm overflow-x-auto whitespace-pre-wrap break-words p-3 bg-white border border-gray-300 rounded-md text-gray-800"></pre>
                    
                    <button onclick="salvarTermosTxt()" id="save-txt-button"
                            class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        Salvar Lista em .txt
                    </button>
                </div>
                <p id="consulta-error" class="text-red-500 mt-4 hidden"></p>
            </div>

            <!-- Telas 2 e 3 foram removidas -->

        </div>

    </div>

    <!-- Script JavaScript -->
    <script type="module">
        // Importa o pdfjsLib de dentro do escopo do módulo
        import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

        let lastExtractedTerms = []; 

        /**
         * Lida com a navegação entre as telas.
         * @param {string} screenId - O ID da tela para a qual navegar.
         */
        window.navigateTo = function(screenId) {
            const screens = document.querySelectorAll('.screen');
            const subtitle = document.getElementById('app-subtitle');

            screens.forEach(screen => {
                screen.classList.add('hidden');
            });

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                
                // Atualiza o subtítulo
                switch(screenId) {
                    case 'home-screen':
                        subtitle.textContent = 'Extração de termos de PDF no lado do cliente.';
                        break;
                    case 'consulta-screen':
                        subtitle.textContent = 'Carregue o arquivo e selecione a estrutura.';
                        break;
                    // As outras telas foram removidas
                }
            }
        }

        /**
         * LÊ O PDF USANDO PDF.JS NO NAVEGADOR E EXTRAI TERMOS.
         */
        window.consultarPdf = async function() {
            const fileInput = document.getElementById('pdf-consulta-file');
            const extractionType = document.getElementById('extraction-type').value;
            const resultArea = document.getElementById('consulta-result-area');
            const termsDisplay = document.getElementById('extracted-terms');
            const errorDisplay = document.getElementById('consulta-error');
            const consultarBtn = document.getElementById('consultar-btn');
            const loadingSpinner = document.getElementById('loading-spinner');

            // Limpeza inicial
            resultArea.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            termsDisplay.textContent = '';
            lastExtractedTerms = [];
            
            if (fileInput.files.length === 0) {
                errorDisplay.textContent = 'Por favor, selecione um arquivo PDF.';
                errorDisplay.classList.remove('hidden');
                return;
            }

            const file = fileInput.files[0];

            // Ativa o estado de carregamento
            consultarBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            termsDisplay.textContent = `Lendo e extraindo texto de "${file.name}"...`;

            try {
                // 1. Lê o arquivo como ArrayBuffer (necessário para PDF.js)
                const arrayBuffer = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });

                // 2. Carrega o documento PDF
                const pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdfDocument.numPages;
                let fullText = '';
                
                // 3. Itera sobre todas as páginas e extrai o texto
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // Concatena todos os itens de texto da página
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                    
                    termsDisplay.textContent = `Extraindo texto... Página ${i} de ${numPages}.`;
                }

                // 4. Determina e aplica a Expressão Regular com base na seleção
                // Padrão: [Tipo] seguido por 2 dígitos, underscore, 4 dígitos, underscore, 2 dígitos
                const regexPattern = new RegExp(`${extractionType}\\d{2}_\\d{4}_\\d{2}`, 'g');
                
                const matches = fullText.match(regexPattern) || [];

                // 5. Usa Set para garantir a desduplicação dos termos (Requisito 3)
                const uniqueMatches = [...new Set(matches)];

                // 6. Formatação do resultado
                lastExtractedTerms = uniqueMatches.map(term => `"${term}"`);
                
                if (lastExtractedTerms.length > 0) {
                    const formattedOutput = lastExtractedTerms.join(',\n');
                    termsDisplay.textContent = formattedOutput;
                    resultArea.classList.remove('hidden');
                    document.getElementById('save-txt-button').classList.remove('hidden'); 
                    alertUser('success', `Extração concluída! ${lastExtractedTerms.length} termos únicos (${extractionType}) encontrados.`);
                } else {
                    termsDisplay.textContent = `O arquivo "${file.name}" foi lido, mas nenhum termo no padrão ${extractionType}xx_xxxx_xx foi encontrado.`;
                    resultArea.classList.remove('hidden');
                    document.getElementById('save-txt-button').classList.add('hidden');
                    alertUser('info', `Nenhum termo (${extractionType}) encontrado.`);
                }

            } catch (error) {
                errorDisplay.textContent = `Erro ao processar o PDF: ${error.message}. Certifique-se de que é um arquivo PDF válido.`;
                errorDisplay.classList.remove('hidden');
                console.error("Erro PDF.js:", error);
            } finally {
                // Desativa o estado de carregamento
                consultarBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Salva a lista de termos extraídos em um arquivo .txt.
         */
        window.salvarTermosTxt = function() {
            if (lastExtractedTerms.length === 0) {
                alertUser('info', 'Não há termos para salvar. Realize uma consulta primeiro.');
                return;
            }

            const fileInput = document.getElementById('pdf-consulta-file');
            const type = document.getElementById('extraction-type').value;
            const fileNameBase = fileInput.files.length > 0 ? fileInput.files[0].name.replace(/\.pdf$/i, '') : 'termos_extraidos';

            const content = lastExtractedTerms.join(',\n');
            const blob = new Blob([content], { type: 'text/plain' });
            
            // Cria um link de download temporário
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${fileNameBase}_${type}_extraidos.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);

            alertUser('success', `Arquivo "${a.download}" salvo com sucesso!`);
        }
        
        // Funções de visualização foram removidas

        /**
         * Função de utilidade para exibir mensagens ao usuário (substituindo o alert nativo).
         */
        function alertUser(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Implementação simples de feedback no rodapé
            const appContainer = document.getElementById('app-container');
            let feedback = document.getElementById('app-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'app-feedback';
                feedback.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-medium transition-opacity duration-300 opacity-0';
                appContainer.appendChild(feedback);
            }

            const baseClass = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-medium transition-opacity duration-300';
            
            if (type === 'success') {
                feedback.className = `${baseClass} bg-green-500 opacity-100`;
            } else if (type === 'error') {
                feedback.className = `${baseClass} bg-red-500 opacity-100`;
            } else {
                 feedback.className = `${baseClass} bg-gray-500 opacity-100`;
            }

            feedback.textContent = message;

            // Esconde após 3 segundos
            clearTimeout(feedback.timer);
            feedback.timer = setTimeout(() => {
                feedback.classList.remove('opacity-100');
                feedback.classList.add('opacity-0');
            }, 3000);
        }

        /**
         * PWA - Registro do Service Worker (SW)
         */
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('SW registrado com sucesso. Escopo:', registration.scope);
                        })
                        .catch(error => {
                            console.error('Falha no registro do SW:', error);
                        });
                });
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('home-screen');
            registerServiceWorker(); 
        });

    </script>
</body>
</html>
